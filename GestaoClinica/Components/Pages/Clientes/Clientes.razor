@page "/clientes"
@using GestaoClinica.ViewModel
@using GestaoClinica.Services.Interfaces
@inject IClienteService ClienteService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudPaper Elevation="1" Style="padding: 16px; margin-bottom: 16px; background-color: #FFFFFF;">
    <MudGrid>
        <MudItem xs="12" sm="8" md="6">
            <MudTextField @bind-Value="searchTerm" 
                          Label="Buscar clientes..." 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" 
                          DebounceInterval="300"
                          @oninput="OnSearchChanged" 
                          Style="width: 100%;" />
        </MudItem>
        <MudItem xs="12" sm="4" md="6">
            <div style="display: flex; justify-content: flex-end; gap: 8px;">
                <MudButton Color="Color.Primary" 
                           Variant="Variant.Filled" 
                           OnClick="OpenCreateModal"
                           StartIcon="@Icons.Material.Filled.Add">
                    Novo Cliente
                </MudButton>
            </div>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Elevation="1" Style="background-color: #FFFFFF;">
    <MudTable T="ClienteViewModel" 
              Items="clientes" 
              Hover="true" 
              SortLabel="Ordenar por" 
              Dense="@dense"
              Striped="true"
              @ref="tableInstance">
        <ToolBarContent>
            <MudText>Mostrando @clientes.Count() clientes</MudText>
            <MudSpacer />
            <MudSwitch @bind-Checked="dense" Color="Color.Secondary" T="bool">Modo compacto</MudSwitch>
        </ToolBarContent>
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<ClienteViewModel, object>(x => x.Nome)">Nome</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ClienteViewModel, object>(x => x.CPF)">CPF</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ClienteViewModel, object>(x => x.Telefone)">Telefone</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ClienteViewModel, object>(x => x.Email)">Email</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ClienteViewModel, object>(x => x.Ativo)">Status</MudTableSortLabel></MudTh>
            <MudTh>Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Nome">@context.Nome</MudTd>
            <MudTd DataLabel="CPF">@context.CPF</MudTd>
            <MudTd DataLabel="Telefone">@context.Telefone</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Status">
                <MudChip Size="Size.Small" 
                         Color="@(context.Ativo ? Color.Success : Color.Error)" 
                         Text="@context.Status" 
                         T="string" />
            </MudTd>
            <MudTd DataLabel="Ações">
                @* Botão "Ver" removido conforme solicitado *@
                <MudButton Size="Size.Small" 
                           Variant="Variant.Text" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Edit"
                           OnClick="@(() => OpenEditModal(context))">
                    Editar
                </MudButton>
                <MudButton Size="Size.Small" 
                           Variant="Variant.Text" 
                           Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="@(() => ConfirmDelete(context.IdCliente))">
                    Excluir
                </MudButton>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
        </PagerContent>
    </MudTable>
</MudPaper>

<MudDialog IsVisible="@showCreateDialog" OnClose="@CloseCreateModal" MaxWidth="MaxWidth.Large">
    <DialogContent>
        <ClienteForm Cliente="newCliente" OnSubmit="HandleCreate" OnCancel="CloseCreateModal" />
    </DialogContent>
</MudDialog>

<MudDialog IsVisible="@showEditDialog" OnClose="@CloseEditModal" MaxWidth="MaxWidth.Large">
    <DialogContent>
        <ClienteForm Cliente="selectedCliente" OnSubmit="HandleUpdate" OnCancel="CloseEditModal" />
    </DialogContent>
</MudDialog>

@code {
    private IEnumerable<ClienteViewModel> clientes = new List<ClienteViewModel>();
    private IEnumerable<ClienteViewModel> allClientes = new List<ClienteViewModel>();
    private string searchTerm = string.Empty;
    private bool dense = false;
    private ClienteViewModel newCliente = new ClienteViewModel { Endereco = new EnderecoViewModel() };
    private ClienteViewModel selectedCliente = new ClienteViewModel();
    private MudTable<ClienteViewModel> tableInstance = null!;

    // Variáveis de controle para visibilidade dos diálogos
    private bool showCreateDialog = false;
    private bool showEditDialog = false;
    // Variável showViewDialog removida conforme solicitado

    protected override async Task OnInitializedAsync()
    {
        await LoadClientes();
    }

    private async Task LoadClientes()
    {
        try
        {
            allClientes = await ClienteService.ListarClienteAsync();
            clientes = allClientes;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar clientes: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnSearchChanged(ChangeEventArgs args)
    {
        searchTerm = args.Value?.ToString() ?? string.Empty;
        
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            clientes = allClientes;
        }
        else
        {
            clientes = await ClienteService.ProcurarClientesAsync(searchTerm);
        }
        
        StateHasChanged();
    }

    private void OpenCreateModal()
    {
        newCliente = new ClienteViewModel { Endereco = new EnderecoViewModel() };
        showCreateDialog = true;
    }

    private void CloseCreateModal()
    {
        showCreateDialog = false;
    }

    private async Task HandleCreate()
    {
        try
        {
            await ClienteService.AdicionarAsync(newCliente);
            await LoadClientes();
            Snackbar.Add("Cliente criado com sucesso!", Severity.Success);
            CloseCreateModal();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao criar cliente: {ex.Message}", Severity.Error);
        }
    }

    private void OpenEditModal(ClienteViewModel cliente)
    {
        selectedCliente = new ClienteViewModel
        {
            IdCliente = cliente.IdCliente,
            Nome = cliente.Nome,
            CPF = cliente.CPF,
            DataNascimento = cliente.DataNascimento,
            Telefone = cliente.Telefone,
            Email = cliente.Email,
            Observacoes = cliente.Observacoes,
            Ativo = cliente.Ativo,
            EnderecoId = cliente.EnderecoId,
            Endereco = cliente.Endereco != null ? new EnderecoViewModel
            {
                Logradouro = cliente.Endereco.Logradouro,
                Numero = cliente.Endereco.Numero,
                Complemento = cliente.Endereco.Complemento,
                Cidade = cliente.Endereco.Cidade,
                Uf = cliente.Endereco.Uf,
                Cep = cliente.Endereco.Cep
            } : new EnderecoViewModel()
        };
        showEditDialog = true;
    }

    private void CloseEditModal()
    {
        showEditDialog = false;
    }

    private async Task HandleUpdate()
    {
        try
        {
            await ClienteService.AtualizarAsync(selectedCliente);
            await LoadClientes();
            Snackbar.Add("Cliente atualizado com sucesso!", Severity.Success);
            CloseEditModal();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao atualizar cliente: {ex.Message}", Severity.Error);
        }
    }

    // Métodos OpenViewModal e CloseViewModal removidos conforme solicitado

    private async Task ConfirmDelete(int id)
    {
        var cliente = clientes.FirstOrDefault(c => c.IdCliente == id);
        if (cliente == null) return;

        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Tem certeza que deseja excluir o cliente {cliente.Nome}?");

        if (confirmed)
        {
            try
            {
                await ClienteService.ExcluirAsync(id);
                await LoadClientes();
                Snackbar.Add("Cliente excluído com sucesso!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir cliente: {ex.Message}", Severity.Error);
            }
        }
    }
}